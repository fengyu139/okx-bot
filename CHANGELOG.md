# 更新日志

## [2.0.0] - 2025-10-09

### 新增功能 ✨

#### 1. 日志系统

- 添加了完整的日志记录功能
- 日志自动写入 `okxNewBot.log` 文件
- 支持多个日志级别：INFO, WARN, ERROR, SUCCESS
- 包含时间戳和详细的数据记录
- 控制台和文件同步输出

#### 2. 持仓管理

- 新增 `getPositions()` 函数：查询当前持仓
- 新增 `closePosition()` 函数：智能平仓功能
- 持仓状态实时监控和显示
- 持仓信息包含：方向、数量、均价、盈亏等

#### 3. 止损止盈订单

- 新增 `placeAlgoOrder()` 函数：提交 algo 订单
- 新增 `cancelAlgoOrder()` 函数：取消 algo 订单
- 新增 `getAlgoOrders()` 函数：查询未成交 algo 订单
- 开仓后自动提交止损订单（默认 1.5%）
- 开仓后自动提交止盈订单（默认 3%）
- 支持市价触发机制

#### 4. 状态管理

- 新增 `saveState()` 函数：保存状态到文件
- 新增 `loadState()` 函数：从文件加载状态
- 状态持久化到 `botState.json`
- 程序重启后自动恢复状态
- 状态包含：上次信号、交易时间、当前持仓、错误计数

#### 5. 异常处理

- 连续错误计数机制
- 错误超过 5 次自动暂停 60 秒
- 错误超过 10 次自动停止程序
- 捕获 SIGINT/SIGTERM 信号实现优雅退出
- 全局异常捕获：unhandledRejection, uncaughtException
- 退出前自动保存状态和记录持仓

### 改进优化 🔧

#### 交易逻辑

- 添加持仓检查，避免重复开仓
- 信号反转时自动平仓
- 只在无持仓时执行开仓
- 开仓成功后立即提交止损止盈订单

#### API 调用

- 所有 API 错误统一使用日志系统记录
- 添加详细的错误信息和请求路径
- 改善错误处理和用户提示

#### 代码结构

- 更清晰的函数组织
- 更详细的注释说明
- 更好的错误处理流程
- 移除未使用的变量（px, posSide）

### 文档 📚

- 新增 `README_NewBot.md`：完整功能说明
- 新增 `.env.example`：配置文件模板
- 新增 `CHANGELOG.md`：更新日志

### 修复 🐛

- 修复原代码中止损止盈订单未实际提交的问题
- 修复缺少持仓管理导致的重复开仓问题
- 修复没有错误恢复机制的问题
- 修复程序崩溃后状态丢失的问题

### 安全性 🔒

- 添加错误计数限制防止无限重试
- 添加优雅退出避免状态丢失
- 改进异常捕获避免程序意外崩溃
- 退出前记录持仓信息

---

## [1.0.0] - 原始版本

### 基础功能

- 双均线（SMA）交叉策略
- OKX API 签名和认证
- 简单的市价开仓
- 基础的账户余额查询
- K 线数据获取和 SMA 计算
- 仓位大小计算（基于风险百分比）

### 已知问题

- ❌ 无日志系统
- ❌ 无持仓管理
- ❌ 止损止盈订单未实际提交
- ❌ 无状态持久化
- ❌ 无异常恢复机制
- ❌ 可能重复开仓

---

## 版本说明

版本号格式：主版本号.次版本号.修订号

- **主版本号**：重大功能变更或不兼容的修改
- **次版本号**：新增功能，向下兼容
- **修订号**：问题修复，不改变功能

## 升级建议

从 v1.0 升级到 v2.0：

1. 备份现有配置和数据
2. 更新代码到最新版本
3. 创建 `.env` 文件（参考 `.env.example`）
4. 先在沙盒环境测试所有新功能
5. 确认无误后切换到生产环境
6. 定期检查日志和状态文件

## 后续计划

### v2.1（计划中）

- [ ] 添加 WebSocket 实时行情支持
- [ ] 支持多交易对同时运行
- [ ] 添加更多技术指标（RSI, MACD 等）
- [ ] Web 界面监控面板

### v2.2（计划中）

- [ ] 回测功能
- [ ] 策略参数优化
- [ ] 性能报告生成
- [ ] 风险指标统计

### v3.0（未来）

- [ ] 机器学习策略
- [ ] 多策略组合
- [ ] 云端部署支持
- [ ] 移动端推送通知
