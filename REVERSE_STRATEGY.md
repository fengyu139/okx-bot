# K 线趋势反转策略

## 策略概述

这是一个逆势交易策略，基于价格连续上涨或下跌后的反转预期。

### 核心逻辑

```
每5分钟检测一次
    ↓
获取最近5根10分钟K线
    ↓
判断趋势
    ↓
┌──────────────────┬──────────────────┐
│ 5根K线都上涨      │ 5根K线都下跌      │
│ 预期反转下跌      │ 预期反转上涨      │
│ → 做空           │ → 做多           │
└──────────────────┴──────────────────┘
    ↓
开仓：10倍杠杆，50%仓位
止盈：3% | 止损：2%
```

## 策略参数

| 参数     | 默认值  | 说明                  |
| -------- | ------- | --------------------- |
| 检测间隔 | 5 分钟  | 每 5 分钟执行一次     |
| K 线周期 | 15 分钟 | 分析 15 分钟级别 K 线 |
| K 线数量 | 5 根    | 判断最近 5 根 K 线    |
| 杠杆倍数 | 10x     | 10 倍杠杆             |
| 仓位比例 | 50%     | 使用账户余额的 50%    |
| 止盈     | 3%      | 盈利 3%自动平仓       |
| 止损     | 2%      | 亏损 2%自动平仓       |

## 快速启动

### 方法 1：使用启动脚本

```bash
./startReverse.sh
```

### 方法 2：使用 PM2

```bash
pm2 start ecosystem.reverse.config.js
pm2 logs reverse-btc
```

### 方法 3：直接运行

```bash
SYMBOL=BTC-USDT-SWAP node okxReverseBot.js
```

## 环境变量配置

在 `.env` 文件中添加：

```bash
# OKX API配置
OKX_API_KEY=your_api_key
OKX_SECRET_KEY=your_secret_key
OKX_PASSPHRASE=your_passphrase
OKX_BASE_URL=https://www.okx.com

# 策略参数（可选）
SYMBOL=BTC-USDT-SWAP
LEVERAGE=10                 # 杠杆倍数
POLL_INTERVAL_MS=300000     # 检测间隔（5分钟）
KLINE_COUNT=5               # K线数量
POSITION_SIZE_PCT=0.5       # 仓位比例
TAKE_PROFIT_PCT=0.03        # 止盈3%
STOP_LOSS_PCT=0.02          # 止损2%
```

## 日志位置

```
logs/okx-reverse-{SYMBOL}.log          # 策略日志
states/botState-reverse-{SYMBOL}.json  # 状态文件
```

## 策略特点

### ✅ 优势

- **逆势捕捉反转**：适合捕捉超买超卖后的反转行情
- **明确信号**：5 根 K 线同向才触发，减少假信号
- **双重保护**：自动止盈止损 + 手动备用保护
- **完整日志**：详细记录每根 K 线的趋势分析

### ⚠️ 风险提示

- **趋势延续风险**：强势行情可能继续延续，导致逆势亏损
- **震荡市场**：横盘震荡时可能频繁触发止损
- **时机选择**：反转时机难以精确把握

## 日志示例

### K 线趋势分析

```
[INFO] 📊 K线趋势分析 (最近5根15分钟K线)
{
  "上涨数量": 5,
  "下跌数量": 0,
  "中性数量": 0,
  "当前价格": "42500.0000",
  "趋势详情": [
    "K1: up (0.85%)",
    "K2: up (1.20%)",
    "K3: up (0.65%)",
    "K4: up (0.95%)",
    "K5: up (1.10%)"
  ]
}
[SUCCESS] 🔥 连续5根K线上涨，预期反转 → 做空
```

### 开仓成功

```
[SUCCESS] ✅ 触发做空信号
[INFO] 📊 开仓参数
{
  "方向": "做空",
  "杠杆": "10x",
  "使用资金": "500.00 USDT",
  "合约张数": 117,
  "当前价格": "42500.0000"
}
[SUCCESS] ✅ 开仓成功
[SUCCESS] ✅ 止损单已设置 @ 43350.0000
[SUCCESS] ✅ 止盈单已设置 @ 41225.0000
```

## 参数调整建议

### 保守型（降低风险）

```bash
KLINE_COUNT=7               # 增加到7根K线
POSITION_SIZE_PCT=0.3       # 减少仓位到30%
TAKE_PROFIT_PCT=0.02        # 降低止盈到2%
STOP_LOSS_PCT=0.015         # 收紧止损到1.5%
```

### 激进型（提高收益）

```bash
KLINE_COUNT=3               # 减少到3根K线
POSITION_SIZE_PCT=0.7       # 增加仓位到70%
TAKE_PROFIT_PCT=0.05        # 提高止盈到5%
STOP_LOSS_PCT=0.03          # 放宽止损到3%
```

## 适用场景

✅ **适合使用的市场环境**：

- 震荡市场（区间波动）
- 短期超买超卖后
- 趋势末端反转

❌ **不适合的市场环境**：

- 强势单边趋势
- 重大新闻事件期间
- 流动性极差时

## 监控命令

```bash
# 查看运行状态
pm2 status

# 查看实时日志
pm2 logs reverse-btc

# 查看最近100行日志
tail -100 logs/okx-reverse-BTC_USDT_SWAP.log

# 查看K线分析
grep "K线趋势分析" logs/okx-reverse-BTC_USDT_SWAP.log

# 查看交易信号
grep "连续" logs/okx-reverse-BTC_USDT_SWAP.log
```

## 停止机器人

```bash
# 方法1：使用脚本
./stopReverse.sh

# 方法2：使用PM2
pm2 stop ecosystem.reverse.config.js

# 停止单个实例
pm2 stop reverse-btc
```

## 与其他策略对比

| 策略         | 类型         | 适合市场     | 风险     |
| ------------ | ------------ | ------------ | -------- |
| SMA 均线策略 | 趋势跟踪     | 明确趋势     | 中       |
| 高低点突破   | 突破交易     | 震荡突破     | 中高     |
| **K 线反转** | **逆势交易** | **震荡反转** | **中高** |

## 注意事项

1. **逆势风险**：逆势交易风险较高，建议小仓位测试
2. **止损严格**：必须严格执行止损，避免扛单
3. **市场选择**：选择波动适中的币种
4. **资金管理**：不要满仓，建议总资金的 30%以内
5. **定期监控**：每天检查交易记录和持仓情况

## 功能特性

✅ 自动 K 线趋势分析
✅ 逆势交易信号生成
✅ 自动止盈止损
✅ 手动止盈止损备用保护
✅ 状态持久化
✅ 完整日志记录
✅ 优雅退出处理

---

**免责声明**：逆势交易风险较高，请充分理解策略逻辑后使用。建议先在模拟盘测试。
